%************************************************
\chapter{Problem Statement}\label{ch:problemstatement}
%************************************************

Event subscription is an essential part of event-driven architectures and must consequently be considered when using events in business processes.
While the use of external events is an active topic in research, most approaches only briefly discuss the subscription mechanism and use the \acs{BPMN}~semantics for orientation.
\todo[inline]{ref}
Though event subscription is not directly addressed in the BPMN~specification, the descriptions on intermediate events state:

\paragraph{}
\textit{"For Intermediate Events, the handling consists of waiting for the Event to occur. Waiting starts when the
Intermediate Event is reached. Once the Event occurs, it is consumed."}~\cite{bpmnspec},~p.~440\newline

\noindent The usual interpretation of this excerpt is that the subscription to the event takes place as soon as the event gets enabled, the un-subscription when the event terminates.
\todo[inline]{I need to work with a precise lifecycle}
As pointed out by Mandal~et.~al.~\cite{mandal:2017}, these subscription semantics significantly limit the flexibility of using events in business processes and can cause undesired behavior and fault.
Due to the strict temporal order between event subscription, occurrence and un-subscription as required by the publish-subscribe paradigm, any events that occur before the enabling of the event element will be ignored by the process execution.
That reduces the timespan for events to occur to a potentially small part of the total execution time and means that crucial events might be missed.

In the following section, the problem is further illustrated at the example of two sample scenarios.
The observed situations then lead to the definition of \textit{Event Occurrence Scenarios} and the derivation of a set of requirements that must be fulfilled by a mechanism for flexible event subscription in business processes.

\section{Motivating Examples}\label{ch:motivatingexamples}
% some has been mentioned in the introduction
%illustrate the complexity

To allow a better understanding of the issue, event-driven use-cases from two different domains are presented in the following.
The cases are revealed through their standard BPMN representation.
It is illustrated, why the time of event subscription is of great importance which motivates to study the mechanics and implications of event subscription in business processes.

\paragraph{Delay of a logistics process}
The first example~(\autoref{fig:example-eurotunnel}) is taken from the logistics domain and shows a truck transport that has to cross the English Channel.
The truck driver receives the transport plan for his next tour from France to the UK. By default, the company crosses the Channel using the Eurotunnel, an underground train connection between London and Paris.

\begin{figure}[]
	\myfloatalign
	{\includegraphics[width=1\linewidth]{chapters/requirements/Eurotunnel-simplified.png}}
	\caption{BPMN Model of a Logistics Process using events for route~optimization~(Example 1.1)}
	\label{fig:example-eurotunnel}
\end{figure}

After loading the goods at the factory, the truck will head towards the check-in location of the Eurotunnel.
If everything runs on schedule, the truck crosses the channel on the train and then delivers the goods in Great Britain.
Alternatively, the process considers a route using the ferry from Calais~(FR) to Dover~(UK).
The Eurotunnel administration publishes delay information approximately every 30~minutes through an RSS feed on their website. While it mostly operates on schedule, delays ranging from 15~minutes to several hours occur regularly. It can happen that new information is not published for multiple hours.
Significant delay events (delay~>~30~minutes) are received through a boundary catching message event attached to the activity \textit{Drive to Eurotunnel Check-In}. The boundary event is interrupting, hence the activity is canceled if a delay occurs.
The transport continues towards the ferry terminal and crosses the English Channel over sea. After crossing the channel, the goods are delivered to the recipient.
\todo[inline]{show a cep query for that scenario to make it more precise}

As interpreted from the BPMN specification, the subscription to the boundary event is issued as soon as the related activity is enabled.
Given that events arrive every 30~minutes, there can be a gap of up to half an hour, before the first information becomes available.
In the worst cases, when data isn't published for several hours, this gap will be even bigger.
Let's consider a very busy weekday; A technical fault occurred in the tunnel earlier that day and the train runs 3 hours behind schedule.
The last information on the RSS feed was published at 2:35\,pm. At that time the truck driver is still in the process of loading goods, finishing the activity at 2:40\,pm.
Following the process definition, the driver now departs towards the Eurotunnel check-in.
The system publishes updated information at 3:15~pm, operations are still 2:30\,h behind schedule. The message gets received through the process and the truck driver takes the alternative route to the ferry, but only after heading to the Eurotunnel for 35~minutes. The late change of plans causes an unnecessary delay to the shipment.

\begin{figure}[]
	\myfloatalign
	{\includegraphics[width=1\linewidth]{chapters/requirements/Eurotunnel_part2.png}}
	\caption{Transport via English Channel that is timed to a delivery~slot~(Example~1.2)}
	\label{fig:example-eurotunnel-part2}
\end{figure}

\autoref{fig:example-eurotunnel-part2} is an extension of the the transport process.
In logistics, it is common that a delivery cannot be accepted at an arbitrary time. Instead, the receiving party assigns delivery windows to the transport company.
The transport must arrive during the given time window, otherwise the delivery cannot be completed.
After crossing the English Channel, the process model shows the catching of a message event containing the desired final arrival time at the factory. There is an agreement with the factory, that the delivery slots will be approved 2~hours before the expected arrival.
If the current ETA of the transport is greater or equal to the arrival time, the driver will head to the drop-off point immediately. If the transport is ahead of schedule, the driver will have to delay the delivery to match the time window.

The presented process model illustrates another complexity of using events in processes. Again, the listening to the announcement of a delivery window will start when the event element is enabled, in this case after crossing the English Channel. 
Until an event has been received, the process will not continue. 
Much worse: if the receiving party sends out the arrival time information too early, \ie~while the truck is crossing the channel, the event is missed. If it is not issued again, the process cannot receive a message and will get stuck indefinitely waiting to catch the event.

Neither of the two presented catch events allow for an efficient and reliable execution of the process. They can cause unnecessary delays and even blocking of the process execution.

\todo[inline]{Consider more possible event occurrence times to prepare for the next chapter}

\paragraph{Up-to-date shipping information for an order}
\begin{figure}[]
	\myfloatalign
	{\includegraphics[width=1\linewidth]{chapters/requirements/Retail-Order.png}}
	\caption{Model of a retail order management process (Example 2)}
	\label{fig:example-order}
\end{figure}

A~similar situation can be observed in the order-management process depicted in \autoref{fig:example-order}.
It describes the interaction between customer and seller in a traditional distance retail scenario: After browsing the product catalog, the customer requests a quote for the articles he or she is willing to buy.
The retailer makes an offer including an approximation of the expected shipment date and sends it to the customer. That quote is then either accepted or not and the payment is issued if necessary.
Once the retailer is informed about the placement of the order, the products are packed and shipped as soon as possible.
For articles that are not currently in stock, the retailer must await the shipment from the factory. If any of the factory-shipments is delayed, the retailer cannot ship in time and will announce a delayed shipment date to the customer.
This situation is modeled through a non-interrupting boundary event attached to the \textit{Prepare Shipping} activity, which triggers the sending of the updated shipment date to the customer.

The process shows a number of similarities, but also differences in terms of event-use when compared to the logistics process in Example~1.
At first we look at the three intermediate catch events, \textit{Quote~received}, \textit{Order~canceled} and \textit{Order~placed}.
In each of the cases, the event to be caught is the direct response to a message that was sent right before. While the process will also enter a waiting state until the response arrives, that waiting is not to be interpreted as an unnecessary delay to the process execution.
Other than in Example~1.2\,(\autoref{fig:example-eurotunnel-part2}), there is nothing useful to do before the response is received.
It is furthermore worth noting that the response messages cannot be missed, because the message catch event immediately follows the message send event.

A different situation holds for the boundary event \textit{Shipment Delay}.
While the subscription to a Eurotunnel event can be issued at any time, it does not depend on any process data, the shipment delay has to be observed for each product that is part of the order. A subscription can therefor not be executed before the activity \textit{Prepare~Quote} has terminated. \todo[inline]{show a cep query for that scenario to make it more precise}
Conforming to the definition of the process, the system will listen to shipment delays once the activity \textit{Prepare~Shipping} is enabled and therefor much later than possible.
Any events that occur after the completion of \textit{Prepare~Quote} but before \textit{Prepare~Shipping}, cannot be considered in the process execution and the customer will not be informed about a possible late shipment. That will, for instance, concern events that occur while the customer makes the decision about accepting or canceling the order.

% The first of these three follows the \textit{Send/Receive} Service Interaction Pattern. \todo[inline]{missingref}
% Two parties interact 

\medskip \noindent 
The two presented examples have illustrated the complexity of using events in business processes, especially when all possible event occurrence times are taken into consideration.
Differences have been pointed out as to how exactly the event is placed in the process, if it waits for a direct response to an earlier request or if the event occurrence is unrelated to the execution of that very process.
Motivated by this complexity and the possible implications, it is the goal of this work to evaluate the capabilities of BPMN and to present a concept for the flexible handling of event subscription in business processes.


\section{Event Occurrence Scenarios}
Given the motivating examples, a generic set of \textit{Event Occurrence Scenarios} is defined in this section. 
Each of the scenarios represents a real-world situation and process implementations need to be capable of handling them to avoid negative effects.

\medskip \noindent
The dominant variable to consider is the event occurrence time.
According to the BPMN specification, it is possible to catch an event if it occurs after the event element is enabled. As shown before, it is often impossible to control occurrence time and events do occur outside of the listening time intervals.
An \ac{EOS} describes the time of event occurrence in relation to a specific step in process or engine execution.
The life-cycle of a process within a process engine is explained in \autoref{ch:bg:bpm} and taken as reference. It is assumed that the process and event engine are configured and running.W
An event is considered to always occur before or after a life-cycle step or in between two consecutive steps. 
Given the life cycle steps \textit{process deployment}, \textit{process instantiation} and \textit{event enabling}, the following occurrence scenarios are distinguished in this work:
% they have an implicit temporal order

\begin{aenumerate}
	\item[$EOS_{1}$] While the BPMN event element is enabled
	\item[$EOS_{2}$] The event does not occur
	\item[$EOS_{3}$] Between process instantiation and \\the enabling of the BPMN event
	\item[$EOS_{4}$] Between process deployment and \\process instantiation
	\item[$EOS_{5}$] Before process deployment
\end{aenumerate}\label{def:occurrence-times}
% they are ordered this way to be in line with the assessment chapter

\begin{figure}[]
	\myfloatalign
	{\includegraphics[width=1\linewidth]{chapters/requirements/timeline-event-occurrence.png}}
	\caption{Possible event occurrence times in relation to a process execution life cycle}
	\label{fig:occurrence-timeline}
\end{figure}\todo[inline]{improve figure: include EOS notions, save space, ?}

An overview of the EOSs and the related life-cycle steps is provided in \autoref{fig:occurrence-timeline}, which uses a time-line to illustrate the possible event occurrence times.
The model deliberately excludes event occurrences after termination of the event element, because that would presume that there is no more interest in the event as the execution flow continued on another branch. Otherwise, the process will remain in waiting state until the event occurs.

\todo[inline]{add a back reference to the examples. In example XY, events can occur before... whereas in example...}

As introduced in \autoref{ch:bg:cep}, there is a strict temporal order between event subscription, reception and un-subscription.
To catch an event that occurs as described in any of the EOSs, the related subscription operation has to be executed before the start of the time interval associated with the EOS.
On that basis, the latest possible event subscription time can be derived from each event occurrence scenario and is as follows:
\textit{before process deployment}~($EOS_{5}$), \textit{during process deployment}~($EOS_{4}$), \textit{at process instantiation}~($EOS_{3}$) and when the \textit{BPMN event element is enabled}~($EOS_{1}$).

It is important to highlight that the subscription to an event source can depend on additional context information or process data, which can be a significant limitation to the possible subscription time.
That situation is illustrated in \textit{Example~2}~(\autoref{fig:example-order}), where the subscription to the shipment delay information cannot be executed before the \textit{Prepare~Quote} activity is completed.
More generally put, a \textit{subscription~dependency} is defined as follows:

\begin{description}
	\item[Subscription Dependency]
	The subscription operation is \textit{dependent}, if any of its parameters, for instance the event query, contains a variable value that has to be determined at the time of subscription.
	The value might reference a piece of information from the process instance context, an engine-wide piece of data or external information.
	In case of a dependence, the subscription cannot be issued before the associated information is available.
\end{description}

If a subscription dependency resolves before the process execution reaches the event element, it should still be possible to flexibly chose the subscription time in the process.
For that reason, in addition to the four subscription-time options presented earlier, an additional option \textit{at any time during process execution} must be available.


\section{Requirements Definition}
The previous sections have exemplified how the execution semantic offered by the BPMN specification limits users in the use of events in business processes. Now these shortcomings are formalized into an additional set of requirements that must be met by a process execution environment to enable event handling in the extended set of event occurrence scenarios.
The formal requirements will later be used to evaluate the capabilities of current Process Management Solutions~(\autoref{ch:assessment}) and to develop a new concept to handling event subscription in business processes~(\autoref{ch:flexibleeventsubscription}).

\paragraph{R1: Flexible Event Subscription Time}

\begin{description}
	\item[R1.1 Explicitness:] 
	For each event that is used in a business process, it must be possible to derive the time of event subscription from the process model. The time of subscription may either be explicitly stated or defined implicitly.
	\item[R1.2 Flexibility:] 
	The time of subscription can be influenced to catch events according to any of the event occurrence scenarios O1, O2, O3, O4. In other words, the process model defines the earliest acceptable time for an event occurrence to be considered in the process execution. The necessary options are \textit{since system start}, \textit{since process deployment}, \textit{since process instantiation}, from an arbitrary but \textit{explicit time during process execution}, or \textit{since enabling of the Event Process Element}.
\end{description}


\todo[inline]{limited by subscription dependencies}
\todo[inline]{change the options back to the times of subscription. Mention that the subscription is necessary before the time of event occurrence, but too early subscription is also a problem.}
\todo[inline]{target only intermediate events. (limitation, although it also makes the most sense.)}

\paragraph{R2: Automatic Subscription Handling}

\begin{description}
	\item[R2.1 Subscription:] 
	The subscription to event sources is handled implicitly by the process execution environment as defined by the process model.
	\item[R2.2 Removal of Subscription:] 
	The removal of a subscription from the system is handled automatically as soon as a subscription becomes unnecessary.
\end{description}


\begin{description}
	\item[R3 Event Buffering:]
	To make all events since the subscription time available during process execution, matching events need to be stored temporarily.
\end{description}

\todo[inline]{buffer policies?}
\todo[inline]{variables and subscription dependencies}

\medskip \noindent
\todo[inline]{write connecting paragraph}
The remainder of this work will further analyze the capabilities of BPMN to express event-usage scenarios and propose solutions to the mentioned problems...
